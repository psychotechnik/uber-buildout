[buildout]
extends = ${buildout:uber-buildout-url}/uwsgi.cfg

parts = ${nginx:parts}

[nginx]
parts = nginx-config nginx-config-install

[nginx-config]
recipe = collective.recipe.template
output = ${buildout:parts-directory}/etc/${uwsgi-server:host}.nginx.conf
inline =
    server {
        listen   80;
        server_name ${buildout:global-server-hostname};

        access_log /var/log/nginx/${buildout:global-server-hostname}.access.log;
        error_log /var/log/nginx/${buildout:global-server-hostname}.error.log;

        location / {
            include uwsgi_params;
            uwsgi_pass 127.0.0.1:${uwsgi-server:socket-port};
        }
        location /media {
            alias "${buildout:directory}/${buildout:project_name}/media";
        }
        location /static {
            alias "${buildout:directory}/${buildout:project_name}/static";
        }

    }

[nginx-config-install]
recipe = collective.recipe.template
output = ${buildout:bin-directory}/install_nginx
mode = 755
inline =
    sudo rm ${uwsgi-server:nginx-conf-path}/sites-available/${uwsgi-server:host}.nginx.conf
    sudo rm ${uwsgi-server:nginx-conf-path}/sites-enabled/${uwsgi-server:host}.nginx.conf
    sudo ln -s ${buildout:parts-directory}/etc/${uwsgi-server:host}.nginx.conf ${uwsgi-server:nginx-conf-path}/sites-available/${uwsgi-server:host}.nginx.conf
    sudo ln -s ${uwsgi-server:nginx-conf-path}/sites-available/${uwsgi-server:host}.nginx.conf  ${uwsgi-server:nginx-conf-path}/sites-enabled/${uwsgi-server:host}.nginx.conf
    sudo service nginx restart
